<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAROT_OS // TACTICAL_STRATEGY_UNIT v5.1.1</title>
    <link rel="manifest" href="/manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        :root {
            --bg-deep: #0a0a0b;
            --ui-grey: #4a4d52;
            --ui-blue: #7898ab;
            --ui-green: #4ade80;
            --ui-border: #2d2f33;
        }

        body { 
            font-family: 'Share Tech Mono', monospace; 
            background-color: var(--bg-deep); 
            color: var(--ui-blue);
            background-image: 
                radial-gradient(circle, #ffffff05 1px, transparent 1px),
                linear-gradient(to right, #ffffff02 1px, transparent 1px),
                linear-gradient(to bottom, #ffffff02 1px, transparent 1px);
            background-size: 40px 40px, 20px 20px, 20px 20px;
        }

        .osint-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            opacity: 0.1;
            background-image: 
                linear-gradient(var(--ui-blue) 1px, transparent 1px),
                linear-gradient(90deg, var(--ui-blue) 1px, transparent 1px);
            background-size: 100px 100px;
        }

        .crosshair {
            position: absolute;
            width: 20px;
            height: 20px;
            pointer-events: none;
            opacity: 0.4;
        }
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background-color: var(--ui-blue);
        }
        .crosshair-tl { top: 10px; left: 10px; }
        .crosshair-tr { top: 10px; right: 10px; }
        .crosshair-bl { bottom: 10px; left: 10px; }
        .crosshair-br { bottom: 10px; right: 10px; }
        .crosshair::before { width: 100%; height: 1px; top: 50%; }
        .crosshair::after { height: 100%; width: 1px; left: 50%; }

        .loading-bar-container {
            width: 100%;
            height: 4px;
            background: #1a1c1e;
            overflow: hidden;
            border: 1px solid var(--ui-border);
        }
        .loading-bar-progress {
            width: 0%;
            height: 100%;
            background: var(--ui-blue);
            animation: progress 2s infinite ease-in-out;
        }
        @keyframes progress {
            0% { width: 0%; left: 0; }
            50% { width: 70%; left: 15%; }
            100% { width: 0%; left: 100%; }
        }

        .card-frame {
            border: 1px solid var(--ui-border);
            transition: border-color 0.3s ease;
        }
        .card-frame:hover {
            border-color: var(--ui-blue);
        }

        .intel-report {
            background: rgba(15, 17, 20, 0.8);
            border-left: 4px solid var(--ui-blue);
            padding: 2rem;
            line-height: 1.8;
        }

        .timestamp { font-size: 0.7rem; color: var(--ui-grey); }
        
        .cursor::after { content: '▊'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        .reversed-card { transform: rotate(180deg); }
        
        strong, b { color: #fff; font-weight: 700; border-bottom: 1px dotted var(--ui-blue); }
    </style>
</head>
<body class="min-h-screen w-screen overflow-x-hidden overflow-y-auto flex flex-col p-4 md:p-12 selection:bg-blue-900 selection:text-white">
    
    <div class="osint-grid"></div>
    <div class="crosshair crosshair-tl"></div>
    <div class="crosshair crosshair-tr"></div>
    <div class="crosshair crosshair-bl"></div>
    <div class="crosshair crosshair-br"></div>

    <header class="border-b border-white/10 pb-4 mb-12 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
            <div class="flex items-center gap-3">
                <span class="text-xs bg-white/10 px-2 py-0.5 text-white">CLASSIFIED</span>
                <h1 class="text-2xl md:text-3xl font-bold tracking-[0.3em] text-white">TAROT_OS <span class="text-xs opacity-50 font-normal">v5.1.1 (TACTICAL_OS)</span></h1>
            </div>
            <p class="text-[10px] mt-2 tracking-widest text-white/40 uppercase">Terminal Connection: Established // Signal: High_Fidelity // Node: 26</p>
        </div>
        <div class="text-right font-mono text-[10px] leading-tight opacity-60">
            <p id="live-coords">LAT: 35.6895 | LNG: 139.6917</p>
            <p id="live-time">UTC 2026-03-01 05:21:44</p>
            <p>SYNC_STATUS: OPERATIONAL</p>
        </div>
    </header>

    <main class="max-w-6xl mx-auto w-full flex-grow">
        <!-- Input Section -->
        <section class="mb-12">
            <div class="flex items-center gap-2 mb-2">
                <span class="w-2 h-2 bg-blue-500"></span>
                <label for="question" class="text-xs tracking-widest uppercase opacity-60">Query Parameters / Mission Objective</label>
            </div>
            <div class="relative">
                <input type="text" id="question" placeholder="Enter query string for probabilistic assessment..." 
                       class="w-full bg-[#0f1114] border border-[#2d2f33] p-4 text-white focus:outline-none focus:border-blue-500/50 transition-colors text-lg font-mono">
                <div class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] opacity-30 hidden md:block">AWAITING_INPUT...</div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-4">
                <button onclick="drawCard('single')" class="group border border-[#2d2f33] p-4 hover:bg-white hover:text-black transition-all flex flex-col justify-between items-start text-left h-full">
                    <div class="mb-2 w-full">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] opacity-50 group-hover:opacity-100">[01_SINGLE_UNIT]</span>
                            <span class="text-[7px] opacity-20 group-hover:opacity-40 tracking-tighter uppercase">Stat: Active</span>
                        </div>
                        <div class="border-l-2 border-blue-500 pl-2">
                            <span class="text-sm font-bold tracking-widest uppercase block">單張神諭</span>
                            <span class="text-[8px] opacity-30 group-hover:opacity-60 block tracking-tight mt-0.5">UNIT_ID: CORE_ORACLE</span>
                        </div>
                    </div>
                    <p class="text-[9px] opacity-20 group-hover:opacity-40 mt-auto font-mono uppercase italic tracking-tighter">
                        [EXEC: QUICK_SCAN] // BINARY_OUTCOME_PROJECTION
                    </p>
                </button>

                <button onclick="drawCard('time_flow')" class="group border border-[#2d2f33] p-4 hover:bg-white hover:text-black transition-all flex flex-col justify-between items-start text-left h-full">
                    <div class="mb-2 w-full">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] opacity-50 group-hover:opacity-100">[03_TEMPORAL_VECTOR]</span>
                            <span class="text-[7px] opacity-20 group-hover:opacity-40 tracking-tighter uppercase">Stat: Active</span>
                        </div>
                        <div class="border-l-2 border-blue-500 pl-2">
                            <span class="text-sm font-bold tracking-widest uppercase block">時間之流</span>
                            <span class="text-[8px] opacity-30 group-hover:opacity-60 block tracking-tight mt-0.5">UNIT_ID: TIME_CHRONO</span>
                        </div>
                    </div>
                    <p class="text-[9px] opacity-20 group-hover:opacity-40 mt-auto font-mono uppercase italic tracking-tighter">
                        [EXEC: TIMELINE_ANALYSIS] // V-P-F_CHRONO_MAP
                    </p>
                </button>

                <button onclick="drawCard('choice')" class="group border border-[#2d2f33] p-4 hover:bg-white hover:text-black transition-all flex flex-col justify-between items-start text-left h-full">
                    <div class="mb-2 w-full">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] opacity-50 group-hover:opacity-100">[05_DECISION_MATRIX]</span>
                            <span class="text-[7px] opacity-20 group-hover:opacity-40 tracking-tighter uppercase">Stat: Active</span>
                        </div>
                        <div class="border-l-2 border-blue-500 pl-2">
                            <span class="text-sm font-bold tracking-widest uppercase block">二選一陣型</span>
                            <span class="text-[8px] opacity-30 group-hover:opacity-60 block tracking-tight mt-0.5">UNIT_ID: OPTION_PATH</span>
                        </div>
                    </div>
                    <p class="text-[9px] opacity-20 group-hover:opacity-40 mt-auto font-mono uppercase italic tracking-tighter">
                        [EXEC: PATH_DIVERGENCE] // ALPHA_BETA_SIMULATION
                    </p>
                </button>
            </div>
        </section>

        <!-- Loading State -->
        <div id="loading" class="hidden py-20 text-center">
            <div class="max-w-xs mx-auto">
                <div class="loading-bar-container mb-4">
                    <div class="loading-bar-progress"></div>
                </div>
                <p class="text-[10px] tracking-[0.4em] animate-pulse">EXECUTING_HEURISTIC_ANALYSIS</p>
            </div>
        </div>

        <!-- Result Box -->
        <div id="result-box" class="hidden space-y-12 animate-in fade-in duration-700">
            <div id="cards-container" class="grid gap-6">
                <!-- Cards injected here -->
            </div>
            
            <div class="intel-report relative">
                <div class="absolute top-0 right-0 p-4 opacity-10 pointer-events-none">
                    <svg width="100" height="100" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="0.5" />
                        <path d="M50 5 L50 95 M5 50 L95 50" stroke="currentColor" stroke-width="0.5" />
                    </svg>
                </div>
                <div class="flex items-center gap-4 mb-6 border-b border-white/10 pb-4">
                    <div class="bg-blue-500 text-black px-2 py-1 text-[10px] font-bold">INTEL REPORT</div>
                    <div class="text-[10px] tracking-widest opacity-50">SUBJECT: PROBABILISTIC_OUTCOME_DETERMINATION</div>
                </div>
                <div id="interpretation" class="text-white/80 text-sm md:text-base selection:bg-blue-500/30">
                    <span class="cursor"></span>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-20 border-t border-white/5 pt-8 text-[9px] tracking-widest opacity-30 flex justify-between uppercase">
        <div>Proprietary OS // Node_26_Deployment</div>
        <div class="flex gap-4">
            <span>Auth: ASUKA_SYNDICATE</span>
            <span>Ref: NERV_SEC_01</span>
        </div>
    </footer>

    <script>
        // Update Time & Coords for realism
        setInterval(() => {
            const now = new Date();
            document.getElementById('live-time').textContent = 'UTC ' + now.toISOString().replace('T', ' ').substring(0, 19);
            // Subtle jitter for coordinates
            const lat = (35.6895 + (Math.random() - 0.5) * 0.001).toFixed(4);
            const lng = (139.6917 + (Math.random() - 0.5) * 0.001).toFixed(4);
            document.getElementById('live-coords').textContent = `LAT: ${lat} | LNG: ${lng}`;
        }, 1000);

        function parseMarkdown(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        async function drawCard(spreadType) {
            const question = document.getElementById('question').value;
            const buttons = document.querySelectorAll('button');
            const resultBox = document.getElementById('result-box');
            const loading = document.getElementById('loading');
            
            buttons.forEach(btn => { btn.disabled = true; btn.classList.add('opacity-30', 'cursor-not-allowed'); });
            resultBox.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const response = await fetch('/api/draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question, spread: spreadType })
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('cards-container');
                    container.innerHTML = '';
                    
                    if (spreadType === 'single') container.className = 'grid grid-cols-1 max-w-sm mx-auto gap-8';
                    if (spreadType === 'time_flow') container.className = 'grid grid-cols-1 md:grid-cols-3 gap-6';
                    if (spreadType === 'choice') container.className = 'grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4';

                    const getLabel = (spread, index) => {
                        if(spread === 'single') return '神諭核心 (CORE)';
                        if(spread === 'time_flow') return ['過去 (PAST)', '現在 (PRESENT)', '未來 (FUTURE)'][index];
                        if(spread === 'choice') return ['現況 (AXIS)', '選擇A-過程 (ALPHA_P)', '選擇A-結果 (ALPHA_R)', '選擇B-過程 (BETA_P)', '選擇B-結果 (BETA_R)'][index];
                    };

                    data.cards.forEach((card, index) => {
                        const imgRotationClass = card.isReversed ? 'reversed-card' : '';
                        const accentColor = card.isReversed ? 'text-red-400' : 'text-blue-400';

                        const cardHtml = `
                            <div class="card-frame p-4 bg-[#0f1114]/50 flex flex-col group">
                                <div class="flex justify-between items-start mb-3 border-b border-white/5 pb-2">
                                    <span class="text-[9px] tracking-tighter opacity-40">POS_${index.toString().padStart(2, '0')}</span>
                                    <span class="text-[9px] font-bold tracking-widest text-white/60">${getLabel(spreadType, index)}</span>
                                </div>
                                
                                <div class="mb-4 bg-black overflow-hidden border border-white/5">
                                    <img src="${card.image}" alt="${card.name_tw}" class="w-full object-cover aspect-[1/1.7] ${imgRotationClass} group-hover:scale-105 transition-all duration-700">
                                </div>
                                
                                <div class="mt-auto">
                                    <h3 class="text-lg font-bold tracking-widest text-white leading-tight uppercase">${card.name_tw}</h3>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="w-1 h-1 ${card.isReversed ? 'bg-red-500' : 'bg-blue-500'}"></span>
                                        <p class="text-[10px] font-bold tracking-widest ${accentColor} opacity-80 uppercase">${card.direction}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.innerHTML += cardHtml;
                    });
                    
                    const interpEl = document.getElementById('interpretation');
                    const formattedText = parseMarkdown(data.interpretation);
                    interpEl.innerHTML = `<div class="font-mono space-y-4 opacity-90">${formattedText}</div><span class="cursor"></span>`;
                    
                    loading.classList.add('hidden');
                    resultBox.classList.remove('hidden');
                    resultBox.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert('SYSTEM_ERROR: ' + data.error);
                }
            } catch (err) {
                alert('CONNECTION_FAILED');
            } finally {
                loading.classList.add('hidden');
                buttons.forEach(btn => { btn.disabled = false; btn.classList.remove('opacity-30', 'cursor-not-allowed'); });
            }
        }
    </script>
</body>
</html>
